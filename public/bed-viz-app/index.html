<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LSMC Genome Performance Explorer</title>
<link rel="stylesheet" href="css/styles.css">
</head>
<body>
<div class="container">

  <header>
    <div class="logo"><img src="logo.png" alt="LSMC"></div>
    <h1>Genome <strong>Performance Explorer</strong></h1>
    <p class="subtitle">Browse genes, build panels, and see how your targets perform on LSMC's Genome</p>
  </header>

  <!-- ── TAB NAVIGATION ──────────────────────────────────────────── -->
  <nav class="tab-nav">
    <button class="tab-nav-btn" data-tab="browse" onclick="APP.switchTab('browse')">Browse</button>
    <button class="tab-nav-btn active" data-tab="build" onclick="APP.switchTab('build')">Build <span class="tab-badge" id="buildBadge"></span></button>
    <button class="tab-nav-btn" data-tab="score" onclick="APP.switchTab('score')">Score</button>
  </nav>

  <!-- ── DEPTH SELECTOR (shared across tabs) ─────────────────────── -->
  <div class="depth-selector" style="justify-content:center;align-items:center;">
    <span style="font-size:0.8rem;color:var(--text-dim);padding:0.4rem 0;">Coverage depth:</span>
    <button class="depth-btn" onclick="setDepth(15, this)">15x</button>
    <button class="depth-btn" onclick="setDepth(20, this)">20x</button>
    <button class="depth-btn active" onclick="setDepth(30, this)" id="depth30">30x</button>
    <button class="depth-btn" onclick="setDepth(40, this)">40x</button>
  </div>

  <div class="todo-marker">TODO [DEPTH STRATIFICATION]: Coverage depth selector should swap between pre-computed GQV score sets at each depth from daylily-omics-analysis mosdepth + RTG vcfeval.</div>

  <!-- ═══════════════════════════════════════════════════════════════
       BROWSE TAB — Gene search + coverage track
       ═══════════════════════════════════════════════════════════════ -->
  <div class="tab-pane" id="tab-browse">

    <div class="browse-search-wrap">
      <span class="browse-search-icon">&#x1F50D;</span>
      <input type="text" class="browse-search" id="browseSearch"
             placeholder="Search for a gene (e.g. BRCA1, TP53, CFTR...)"
             autocomplete="off">
      <div class="browse-autocomplete" id="browseAutocomplete"></div>
    </div>

    <!-- Empty state -->
    <div class="browse-empty" id="browseEmpty">
      <div class="browse-empty-icon">&#x1F9EC;</div>
      <p>Search for a gene to see its coverage profile</p>
      <p class="browse-empty-hint">Type a gene name above — try BRCA1, CFTR, or DMD</p>
    </div>

    <!-- Coverage view (hidden until gene selected) -->
    <div class="coverage-section" id="coverageSection">
      <div class="gene-info-bar">
        <div class="gene-info-left">
          <h2 id="browseGeneSymbol"></h2>
          <span class="gene-full-name" id="browseGeneName"></span>
        </div>
        <button class="gene-add-btn" id="browseAddBtn">+ Add to Panel</button>
      </div>
      <div class="gene-info-meta" id="browseGeneMeta"></div>

      <div class="todo-marker">TODO [REAL COVERAGE DATA]: Replace synthetic coverage generator with real per-base/per-window depth data from mosdepth output (HG002 benchmarking at each depth tier). Currently generates gaussian noise around selected depth.</div>

      <div class="coverage-canvas-wrap">
        <canvas id="coverageCanvas"></canvas>
        <div class="coverage-tooltip" id="coverageTooltip"></div>
      </div>

      <div class="coverage-legend">
        <span><span class="legend-dot" style="background:rgba(16,185,129,0.5)"></span> &ge; 30x</span>
        <span><span class="legend-dot" style="background:rgba(245,158,11,0.5)"></span> 20-30x</span>
        <span><span class="legend-dot" style="background:rgba(239,68,68,0.5)"></span> &lt; 20x</span>
        <span><span class="legend-dot" style="background:#3b82f6"></span> Exons</span>
      </div>

      <div class="coverage-metrics">
        <div class="cov-metric">
          <div class="cov-metric-label">Mean Depth</div>
          <div class="cov-metric-value" id="covMeanDepth">&mdash;</div>
        </div>
        <div class="cov-metric">
          <div class="cov-metric-label">&ge; 30x Bases</div>
          <div class="cov-metric-value" id="covAbove30">&mdash;</div>
        </div>
        <div class="cov-metric">
          <div class="cov-metric-label">SNV F-score</div>
          <div class="cov-metric-value" id="covSnvFscore">&mdash;</div>
        </div>
        <div class="cov-metric">
          <div class="cov-metric-label">Indel F-score</div>
          <div class="cov-metric-value" id="covIndelFscore">&mdash;</div>
        </div>
      </div>
    </div>

  </div>

  <!-- ═══════════════════════════════════════════════════════════════
       BUILD TAB — Panel builder / shopping cart
       ═══════════════════════════════════════════════════════════════ -->
  <div class="tab-pane active" id="tab-build">

    <!-- Upload + Presets (moved from Score tab) -->
    <div class="upload-section">
      <div class="upload-col">
        <h4>Upload your panel</h4>
        <div>
          <button class="upload-btn" id="buildUploadBtn">Upload BED file</button>
          <input type="file" id="buildFileInput" accept=".bed,.txt,.tsv,.csv" style="display:none;">
        </div>
        <span class="upload-hint">Standard BED format (chr, start, end) &mdash; or drag a file anywhere on the page</span>
        <div class="upload-drop-hint">Drop your BED file here</div>
      </div>
      <div class="score-preset-panel">
        <h4>Or choose a preset panel</h4>
        <div id="buildTabPresets"></div>
      </div>
    </div>

    <div class="build-layout">
      <div class="build-main">
        <!-- Search + Import row -->
        <div class="build-search-row">
          <div class="build-search-wrap">
            <span class="build-search-icon">&#x1F50D;</span>
            <input type="text" class="build-search" id="buildSearch"
                   placeholder="Add gene to panel..." autocomplete="off">
            <div class="build-autocomplete" id="buildAutocomplete"></div>
          </div>
          <button class="build-import-btn" id="buildImportBtn">Import list</button>
        </div>

        <!-- Cart gene list -->
        <div class="cart-gene-list">
          <div class="cart-header">
            <h3>Panel Genes</h3>
            <button class="cart-clear-btn" id="cartClearBtn">Clear all</button>
          </div>
          <div id="cartGeneList"></div>
          <div class="cart-empty" id="cartEmpty">
            No genes added yet. Search above or choose a preset panel.
          </div>
        </div>
      </div>

      <!-- Sidebar: stats + presets -->
      <div class="build-sidebar">
        <div class="build-sidebar-card">
          <h4>Panel Summary</h4>
          <div class="cart-stats">
            <div class="cart-stat">
              <div class="stat-value" id="cartCountStat">0</div>
              <div class="stat-label">Genes</div>
            </div>
            <div class="cart-stat">
              <div class="stat-value" id="cartSizeStat">0 bp</div>
              <div class="stat-label">Total Size</div>
            </div>
            <div class="cart-stat">
              <div class="stat-value" id="cartSnvStat">&mdash;</div>
              <div class="stat-label">SNV F-score</div>
            </div>
            <div class="cart-stat">
              <div class="stat-value" id="cartIndelStat">&mdash;</div>
              <div class="stat-label">Indel F-score</div>
            </div>
          </div>
          <button class="build-analyze-btn" id="buildAnalyzeBtn" disabled>
            Analyze Panel &rarr;
          </button>
        </div>

        <div class="build-sidebar-card">
          <h4>Quick Load Presets</h4>
          <div id="buildPresets"></div>
        </div>
      </div>
    </div>

    <!-- Import modal -->
    <div class="import-modal" id="importModal">
      <div class="import-modal-body">
        <h3>Import Gene List</h3>
        <textarea id="importTextarea" placeholder="Paste gene symbols, one per line or comma-separated:&#10;BRCA1&#10;BRCA2&#10;TP53&#10;MLH1"></textarea>
        <p class="import-hint">Accepts gene symbols separated by newlines, commas, or tabs.</p>
        <div class="import-modal-actions">
          <button class="import-cancel-btn" id="importCancelBtn">Cancel</button>
          <button class="import-submit-btn" id="importSubmitBtn">Add Genes</button>
        </div>
      </div>
    </div>

  </div>

  <!-- ═══════════════════════════════════════════════════════════════
       SCORE TAB — Genome viz + summary cards + detail tables
       ═══════════════════════════════════════════════════════════════ -->
  <div class="tab-pane" id="tab-score">

    <div class="todo-marker">TODO [BED VALIDATION]: Wire server-side BED parser with format detection, auto-conversion, and region validation.</div>

    <div class="format-banner" id="formatBanner"></div>

    <!-- Progress -->
    <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="scan-status" id="scanStatus"><span class="blink"></span> <span id="scanText"></span></div>

    <!-- Genome Viz -->
    <div class="viz-section" id="vizSection">
      <div class="section-header">
        <h2>Genome Performance Map <span id="panelLabel" style="color:var(--text-dim);font-weight:300;"></span></h2>
        <span class="meta" id="regionCount"></span>
      </div>

      <div class="todo-marker">TODO [IDEOGRAM DATA]: Replace synthetic ideogram with real hg38 cytoBandIdeo.txt data.</div>

      <div class="genome-canvas-wrap">
        <canvas id="genomeCanvas"></canvas>
      </div>

      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="summary-card pass">
          <div class="card-label">SNV F-score</div>
          <div class="card-value value-green" id="snvScore">&mdash;</div>
          <div class="card-sub">Threshold: &ge; 0.995</div>
        </div>
        <div class="summary-card pass">
          <div class="card-label">Indel F-score</div>
          <div class="card-value value-green" id="indelScore">&mdash;</div>
          <div class="card-sub">Threshold: &ge; 0.990</div>
        </div>
        <div class="summary-card pass">
          <div class="card-label">Callability</div>
          <div class="card-value value-green" id="callScore">&mdash;</div>
          <div class="card-sub">Fraction callable</div>
        </div>
        <div class="summary-card pass">
          <div class="card-label">Regions Covered</div>
          <div class="card-value value-green" id="coveredScore">&mdash;</div>
          <div class="card-sub">of uploaded targets</div>
        </div>
      </div>

      <div class="todo-marker">TODO [GQV SATISFACTION]: Use check_satisfaction.py pattern for real pass/fail per product spec constraint.</div>
      <div class="todo-marker">TODO [SV/CNV METRICS]: Add SV/CNV accuracy card (cnv_deldup.precision/recall from GQV schema).</div>

      <div id="tierBadge" class="tier-badge clinical" style="display:none;"></div>

      <div class="todo-marker">TODO [PERFORMANCE CERTIFICATE]: Generate downloadable PDF/HTML performance certificate.</div>

      <!-- Stratification -->
      <div class="section-header" style="margin-top:2rem;"><h2>Performance by Region Type</h2></div>

      <div class="todo-marker">TODO [REGION STRATIFICATION]: Intersect user BED with GIAB stratification BED files for real region classes.</div>

      <div class="strat-section">
        <div class="strat-card">
          <h4>SNV F-score by Region</h4>
          <div id="snvStratBars"></div>
        </div>
        <div class="strat-card">
          <h4>Indel F-score by Region</h4>
          <div id="indelStratBars"></div>
        </div>
      </div>

      <!-- Results Table -->
      <div class="results-table-wrap">
        <div class="results-table-header">
          <h3>Per-Region Detail</h3>
          <div class="tab-group">
            <button class="tab-btn results-tab-btn" data-view="genes">By Gene</button>
            <button class="tab-btn results-tab-btn active" data-view="chroms">By Chromosome</button>
          </div>
        </div>

        <div class="todo-marker">TODO [REAL DATA PIPELINE]: Wire per-gene table to pre-computed GQV metrics from HG002 benchmarking.</div>

        <div class="table-toolbar" id="tableToolbar">
          <div class="search-wrap">
            <span class="search-icon">&#x1F50D;</span>
            <input type="text" class="gene-search" id="scoreGeneSearch" placeholder="Search genes...">
          </div>
          <span class="result-count" id="resultCount"></span>
        </div>
        <table>
          <thead id="resultsHead"></thead>
          <tbody id="resultsBody"></tbody>
        </table>
        <div class="pagination" id="pagination"></div>
      </div>

      <div class="todo-marker">TODO [DOWNLOADABLE REPORT]: Add "Download Performance Report" button for PDF/HTML export.</div>
    </div>
  </div>

</div>

<!-- STICKY CTA BAR -->
<div class="cta-bar" id="ctaBar">
  <div class="cta-bar-inner">
    <span class="cta-bar-text"><strong>Ready for a detailed report?</strong> Get TAT options, volume pricing, and a full performance certificate for your panel.</span>
    <button class="cta-bar-btn" id="ctaBtn">Talk to our team &rarr;</button>
  </div>
  <div class="todo-marker">TODO [CTA WIRING]: Connect to lsmc-customer-agent with panel context.</div>
</div>

<button class="dev-toggle" id="devToggle">{ } TODOs</button>

<!-- ── SCRIPTS (order matters: shared → genes → tabs) ──────────── -->
<script src="js/shared.js"></script>
<script src="js/genes.js"></script>
<script src="js/browse.js"></script>
<script src="js/build.js"></script>
<script src="js/score.js"></script>
<script>
// ── Global handlers ──────────────────────────────────────────────
function setDepth(d, btn) {
  APP.currentDepth = d;
  document.querySelectorAll('.depth-btn').forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  APP.emit('depthChanged', d);
}

document.getElementById('devToggle').addEventListener('click', function() {
  document.body.classList.toggle('show-todos');
});
</script>
</body>
</html>
